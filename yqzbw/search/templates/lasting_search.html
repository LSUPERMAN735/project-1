<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
	<title>搜索工具</title>
	<meta charset="utf-8" />
<style>
body{background:#ffffff;padding:0px;margin:0px;font-size:14px;}
.header{
height:5px;
line-height:50px;
border-bottom:1px solid #ccc;
background:#f7f7f7;
text-indent:10px;
width: 100%;
position: fixed;
_position: absolute;
z-index: 1;
top: 0;
left: 0;
box-shadow: 2px 2px 15px #999; 
_top: expression(eval(document.documentElement.scrollTop));
}
#search{width: 80%;}
#browser{display: none;}
#two_btn{margin-left: 1%;}
.search_tool{padding:30px 10px;width:900px;margin:0 auto;background:#f7f7f7;min-height: 1750px;border-color:#ccc;border-style:solid;border-width:0px 1px 1px 1px;box-shadow: 2px 2px 15px #999; }
.search{border: 1px solid #D9D9D9;background-color: #E6E6E6;padding: 4px;height: 28px;width: 674px;float:left;margin:0px;}
.input_tag{float:left;padding: 7px 6px 6px 8px;border: 1px solid #C5C5C5;width: 550px;height: 13px;line-height: 13px;font-size: 12px;color: #515151;background-color: white;z-index: 0;}
.search_btn{cursor: pointer;width: 100px;height: 28px;line-height: 28px;border: 1px solid #296bba;background: #3c75ba;font-weight: bold;color: white!important;text-decoration: none;text-align: center;font-size: 14px;float:right;}

.tabs_tool,tabs_tool li{list-style:none;padding:0px;margin:0px;font-size:13px;}
.tabs_tool li{height:20px;line-height:20px;margin:2px 0px;padding-left:10px; }
.tabs_tool li a{color:#00c;text-decoration:underline;}
.tabs_tool li b{color:#FEF6CE;}
.tabs_tool li.current{font-weight:600;}
.tabs_tool li.current a{color:#333;text-decoration:none;}
.tabs_tool li.current b{color:#333;}
.tabs_title{height: 30px;line-height: 30px;text-indent: 10px;font-weight: 600;color: #333;font-size:14px; border-top: 1px solid white;border-bottom: 1px solid #C8C8C8;background-color: #F2F2F2;margin:0px;}

.s_item{margin-bottom:10px;border:1px solid #ccc;padding:10px;background: #fff;}
.s_item .title{color:#00C;font-size:16px;text-decoration:underline;}
.s_item .content{color:#000;font-size:13px;line-height:120%;padding-top:5px;}
.s_item .message{color:green;font-size:12px;line-height:120%;padding-top:2px;}
.s_item em{font-weight:normal;color:#C00;text-decoration: underline;font-style: normal;}
.s_item .content em{text-decoration: none;}
.s_item.current{border:1px solid #f84f59;background: #f9e6e7;}
.s_item_select{display:none; position: absolute;right: -11px;top: -11px;border:1px solid #ccc;padding:10px;background:#ccc;cursor: pointer;}
.s_item.current .s_item_select{border:1px solid #f84f59;background: #f84f59;}

.navigation_tool{display:none;background-color:#fef6ce;border: 1px solid #ead483; margin: 0 auto;width: 920px;height: 50px;line-height: 50px;text-align: center;color:#666;font-size: 12px;}
.navigation_tool .current{display:inline-block;border-bottom:2px solid #2f9db3;color:#2f9db3;font-size: 18px;height: 49px;line-height: 50px;font-weight: 600;padding:0px 10px;}

.navigation_tool div{width:627px;height:32px;margin:10px auto; background-image: url("http://wooxun.com:80/resource/client/images/navigation_tool_bg.jpg");background-position: 0px -65px;}

.search_message{clear:both;background-color:#fef6ce;border: 1px solid #ead483; margin:15px 0 10px 0px;height: 35px;line-height: 35px;text-align: center;color:#666;font-size: 12px;}

#download{display: none;}
p{font-size: 2em;}
#lc ul li ul{list-style-type: none;}
#tal{color: rosybrown;}
.label{font-size: 1.5em;cursor: pointer;}
#lil{overflow: hidden;text-overflow:ellipsis;white-space:nowrap;}
#time1 , #time2{height: 15px;font-size: 0.5em;}
#times{height: 25px;}
.category ,.page , .type , .only , .time , .export , .word , .show_hide{cursor: pointer;}
#pagination{float: left;display: none;width: 100%;}
#mongo{font-size: 1em; color: red;}
#mongo_sum{font-size: 1.5em;color: orangered;}
#accordion{width: 20%;float: right;margin-top: 25px;}
#accordion>div>ul{margin-left: -10%;font-size: 0.8em;}
#book{float: right;margin-right: 10%;height: 20px;}
.form_datetime{width: 10%;height: 15px;}
#loading{text-align: center;margin-top: 100px;display: none;}
#menu{margin-left: 30%;margin-top: -50px;height: 30px;font-size: 0.8em;width: 60%;}
.validateTips{font-size: 1em;}
.badges-important{text-decoration: none;cursor: default;color: black;}
</style>
<script src="/static/js/jquery-1.9.1.js"></script>
<script src="/static/js/jquery-ui.js"></script>
<link href="/static/bootstrap-datetimepicker-master/css/datetimepicker.css" rel="stylesheet"></link>
<link rel="stylesheet" href="/static/css/jquery-ui.css">
<link href="/static/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.css" rel="stylesheet"></link>
<link href="/static/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css" rel="stylesheet"></link>
<!-- <script src="/static/js/date_time_format.js"></script> -->
<link href="/static/css/bootstrap.min.css" rel="stylesheet"></link>
<link href="/static/css/bootstrap.css" rel="stylesheet"></link>
<link href="/static/css/bootstrap-responsive.css" rel="stylesheet"></link>
<link href="/static/css/bootstrap-responsive.min.css" rel="stylesheet"></link>
<link href="/static/css/docs.css" rel="stylesheet"></link>
<link href="/static/css/prettify.css" rel="stylesheet"></link>

<script type="text/javascript">
$(function () {
	$('.category,.type,.only,.time,.word').click(function () {
	  if ($(this).hasClass('disabled')==false&&$(this).hasClass('active')==false&&$(this).hasClass('badges-important')==false) {
  	  var value=$('#kw').val().replace(/‘|’|“|”/g,"\"");
  	      nu = $(this).attr('id');
  	      s_time = '';
  	      dt_wd = {28: '',29: 2,30: -2,31: 1,32: -1,33: 0,34: 9};
  	      d_word = '';
  	  if (value) {
  	    if (nu!='btn'&&nu!='times'&&nu!='two_btn') {
    	    if (nu<5) {
    	      $('.category').removeClass('active');
    	      $('#'+nu+'').addClass('active');
          }else if (nu<10) {
    	      $('.type').removeClass('badges-important').addClass('badges-success');
    	      $('#'+nu).removeClass('badges-success').addClass('badges-important');
    	      var nu = nu-5;
          }else if (nu<24) {
            $('.only').removeClass('badges-important').addClass('badges-success');
          	if (nu==21) {
          	  $('#21').removeClass('badges-success').addClass('badges-important');
            	value='title:'+value.split(':').slice(-1)[0];
            }else if (nu==22) {
              $('#22').removeClass('badges-success').addClass('badges-important');
              value='content:'+value.split(':').slice(-1)[0];
            }else if (nu==23) {
            $('#23').removeClass('badges-success').addClass('badges-important');
            value='sitename:'+value.split(':').slice(-1)[0];
            }else {
            	$('#20').removeClass('badges-success').addClass('badges-important');
            	value=value.split(':').slice(-1)[0];
            }
          }else if (nu<28) {
          	$('.time').removeClass('badges-important').addClass('badges-success');
          	if (nu==25) {
          	  $('#25').removeClass('badges-success').addClass('badges-important');
            	s_time= datetime_format(1);
            }else if (nu==26) {
              $('#26').removeClass('badges-success').addClass('badges-important');
              s_time= datetime_format(24);
            }else if (nu==27) {
              $('#27').removeClass('badges-success').addClass('badges-important');
              s_time= datetime_format(168);
            }else {
            	$('#24').removeClass('badges-success').addClass('badges-important');
            	s_time = '';
            }
          }else {
          	$('.word').removeClass('badges-important').addClass('badges-success');
          	$(this).removeClass('badges-success').addClass('badges-important');
          	d_word = 'word:' + dt_wd[$(this).attr('id')];
          }
        }else if (nu=='times') {
        	var get_time1 = $('#time1').val();
        	    get_time2 = $('#time2').val();   
              s_time = 'ctime:['+get_time1+' TO '+get_time2+']';              	
        }else if (nu=='two_btn') {
        	var two = $('#kw').val().replace(/‘|’|“|”/g,"\"");
        	   value = two_search+two;
        }
        window.two_search=value;
        if (s_time!=''&&value!='') {
          if (value.indexOf('ctime') >= 0) {
          	var value = value.replace(/ctime:.*]/,s_time)
          }else {
          	var value = value + ' AND ' + s_time;
          }	        
        }else if (value=='') {
        	var value = s_time;
        }
        if (d_word!='') {
        	var value = value +' AND '+ d_word;
        }
        var num = $('.category.active').attr('id');
            srh = $('.type.badges-important').attr('id');
            vvv = handle(value,num,srh);
            val = handles(value,num);
        $('#chart').fadeOut();
        $('#loading').fadeIn();
        $('#pagination').fadeOut();
        $('#btn').addClass('disabled');
        console.log((vvv,val.con))
  	    $.getJSON("/hudie/?value="+vvv+"&sk=0&con="+val.con,function (data) {
    	    if (data.result.length>0) {
  	      if (data.count.toString().slice(-1) == '0') {
  	      	window.cou=parseInt(data.count/10);
          }else {
	          window.cou=parseInt(data.count/10)+1;
          }
  	      //$('#kw').val(value);
    	    $('#lc').fadeIn();
          	$('#pagination').fadeIn();
          	$('#btn').removeClass('disabled');
      	    console.log(data);
      	    tables(data,vvv);
      	    if (cou==1) {
            	tables(data,vvv);
            	$('#pagination').fadeOut();
            }else {
      	      shuaye1(cou);
      	      $('#pagination').fadeIn();
      	    } 
          }else {
            $('#loading').hide();
            $('#chart').fadeIn();
            $('#pagination').fadeOut();
            $('#btn').removeClass('disabled');
          	$('#chart').html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;找到约 0 条结果<br />')
          }  	    
        });
      }else if (nu<5) {
        $('#pagination').fadeOut();
  	    $('.category').removeClass('active');
  	    $('#'+nu).addClass('active');
      }else if (nu<10) {
      	$('#pagination').fadeOut();
      	$('.type').removeClass('badges-important').addClass('badges-success');
    	  $('#'+nu).removeClass('badges-success').addClass('badges-important');
      }
    }
  });
  $('#page').on('click','.page',function () {
    if ($(this).hasClass('disabled')==false&&$(this).hasClass('active')==false) {
  	  var nu = $('.page.active a').text();
  	  	  nt = $('.page.active').attr('id');
  	      di = $(this).attr('id');
  	  if ($(this).next().attr('id')=='down'&&$(this).text()!=1&&$(this).text()!=cou||$(this).prev().attr('id')=='up'&&$(this).text()!=1&&$(this).text()<parseInt(cou)) {
        num = parseInt($(this).text())+4;
      	shuaye(num);
      }else {
      	fanye(nu,di,nt);
      }
    }	  
  });
});
  function fanye(nu,di,nt) {
	  if (di=='down'&&$('.page.active').hasClass('end')==true&&nu!=cou-1) {
	    nu = parseInt(nu)+5;
	    shuaye(nu,15);
    }else if (di=='up'&&$('.page.active').hasClass('start')==true&&nu!=2) {
	    var nu = parseInt(nu)+3;
	    shuaye(nu,15);
    }else if (di=='down') {
    	$('.page').removeClass('active');
    	$('#'+nt).next().addClass('active');
    	$('#up').removeClass('disabled');
    	if (nu==cou-1) {
      	$('#down').addClass('disabled');
      }
    }else if (di=='up') {
    	$('.page').removeClass('active');
    	$('#'+nt).prev().addClass('active');
    	$('#down').removeClass('disabled');
    	if (nu==2) {
      	$('#up').addClass('disabled');
      }
    }else {
	    $('.page').removeClass('active');
	    $('#'+di+'').addClass('active');
	    if ($('.page.active').text()==1) {
      	$('#up').addClass('disabled');
      	$('#down').removeClass('disabled');
      }else if ($('.page.active').text()==cou) {
        $('#down').addClass('disabled');
        $('#up').removeClass('disabled');
      }else {
      	$('#up').removeClass('disabled');
      	$('#down').removeClass('disabled');
      }
    }
    var value=$('#kw').val().replace(/‘|’|“|”/g,"\"");
        num = $('.category.active').attr('id');
        srh = $('.type.badges-important').attr('id');
        val = handle(value,num,srh);
        sk  = $('.page.active').text()-1;
        $('#chart').fadeOut();
        $('#loading').fadeIn();
        $('#pagination').fadeOut();
        $.getJSON("/hudie/?value="+val+"&con="+values.con+"&sk="+sk,function (data) {
          tables(data,val);        
        });
  }
  function shuaye(nu,nt) {
    $('.page').removeClass('active');
    if (nu>cou) {
    	var bom = parseInt((cou-5)/4)*4+1;
    	    rmd = parseInt((cou-1)%4+5);
    	    pa = '<li class="page" id="up"><a><<</a></li>';
    	for (var i=0;i<rmd;i++) {
      	pa+= '<li class="page" id="'+(11+i)+'"><a>'+(bom+i)+'</a></li>';
      }
      pa+='<li class="page " id="down"><a>>></a></li>';
      $('#page').html(pa);
      $('#12').addClass('start');
      $('#15').addClass('active');
    }else {
	    pa = '<li class="page" id="up"><a><<</a></li>\
            <li class="page" id="11"><a>'+(parseInt(nu)-8)+'</a></li>\
            <li class="page start" id="12"><a>'+(parseInt(nu)-7)+'</a></li>\
            <li class="page" id="13"><a>'+(parseInt(nu)-6)+'</a></li>\
            <li class="page" id="14"><a>'+(parseInt(nu)-5)+'</a></li>\
            <li class="page" id="15"><a>'+(parseInt(nu)-4)+'</a></li>\
            <li class="page" id="16"><a>'+(parseInt(nu)-3)+'</a></li>\
            <li class="page" id="17"><a>'+(parseInt(nu)-2)+'</a></li>\
            <li class="page end" id="18"><a>'+(parseInt(nu)-1)+'</a></li>\
            <li class="page" id="19"><a>'+nu+'</a></li>\
            <li class="page" id="down"><a>>></a></li>';
      $('#page').html(pa);
      $('#15').addClass('active');
     
    }
    var value=$('#kw').val().replace(/‘|’|“|”/g,"\"");
        num = $('.category.active').attr('id');
        srh = $('.type.badges-important').attr('id');
        vals = handles(value,num);
        val = handle(value,num,srh);
        sk  = $('.page.active').text()-1;
        $('#chart').fadeOut();
        $('#loading').fadeIn();
        $('#pagination').fadeOut();
        $.getJSON("/hudie/?value="+val+"&con="+vals.con+"&sk="+sk,function (data) {
          tables(data,val);        
        });
  }
  function shuaye1(nu) {
    if (nu<=9) {
	    pa = '<li class="page" id="up"><a><<</a></li>';
  	  for (var i=0;i<nu;i++) {
    	  pa+='<li class="page" id="'+(11+i)+'"><a>'+(i+1)+'</a></li>';
      }
    pa+='<li class="page" id="down"><a>>></a></li>';
    $('#page').html(pa);
    $('#11').addClass('active');
    $('#12').addClass('start');
    $('#up').addClass('disabled');
    }else {
      var nu = 9;
    	pa = '<li class="page" id="up"><a><<</a></li>\
            <li class="page" id="11"><a>'+(parseInt(nu)-8)+'</a></li>\
            <li class="page start" id="12"><a>'+(parseInt(nu)-7)+'</a></li>\
            <li class="page" id="13"><a>'+(parseInt(nu)-6)+'</a></li>\
            <li class="page" id="14"><a>'+(parseInt(nu)-5)+'</a></li>\
            <li class="page" id="15"><a>'+(parseInt(nu)-4)+'</a></li>\
            <li class="page" id="16"><a>'+(parseInt(nu)-3)+'</a></li>\
            <li class="page" id="17"><a>'+(parseInt(nu)-2)+'</a></li>\
            <li class="page end" id="18"><a>'+(parseInt(nu)-1)+'</a></li>\
            <li class="page" id="19"><a>'+nu+'</a></li>\
            <li class="page" id="down"><a>>></a></li>';
      $('#page').html(pa);
      $('#up').addClass('disabled');
      $('#11').addClass('active');
    }
  }
  function tables(res,val) {
	  var sel=res.con; 
	      window.num=5000;
	      aaaa = res.count;
	      time=parseInt(res.usetime)/1000; 
	      res=res.result;
	      tb = '<p style="color:#999999;font-size:1em;margin-left:4%;">找到 '+aaaa.format()+' 条结果,用时 '+time+' 秒</p>';
	  for (var i in res) {
	    var site=res[i]['siteName'];
	        tit=res[i]['title'];
	        url=res[i]['url'];        
      if (values.val.sitename) {
        var sit_words = binary_segmentation(values.val.sitename.$regex);
            high = {};
        for (var w in sit_words) {
          high[w+'둘']='<b style="color:red;">'+sit_words[w]+'</b>';
          rp = new RegExp(sit_words[w],'gi');
        	site=site.replace(rp,w+'둘');
        }
        for (var w in high) {
          hg = new RegExp(w,'g');
        	site=site.replace(hg,high[w]);
        }
      }
      if (values.val.title) {
        var tit_words = binary_segmentation(values.val.title.$regex);
        light = {};
        for (var w in tit_words) {
          light[w+'둘']='<b style="color:red;">'+tit_words[w]+'</b>';
          rp = new RegExp(tit_words[w],'gi');
        	tit=tit.replace(rp,w+'둘');
        }
        for (var w in light) {
          lg = new RegExp(w,'g');
        	tit=tit.replace(lg,light[w]);
        }
      }
      if (values.val.url) {
      	 url=url.replace(values.val.url.$regex,'<b style="color:red;">'+values.val.url.$regex+'</b>');
      }
	    tb+='<br /><ul style="list-style-type:none;">\
	             <li style="font-size:1.2em;" id="lil">\
	             <a style="color:#1E0FBE; text-decoration:none;" title="'+res[i]['title']+'" href="'+res[i]['url']+'" target="_blank">'+tit+'</a></li>\
	             <li id="lil" style="color:#006621;">'+url+'</li>\
	             <li>来自:'+res[i]['source']+'--'+site+'</li>\
                     <li>发表时间:'+res[i]['ctime']+'<div style="float:right;">\
                     入库时间:'+res[i]['gtime']+'--<i class="icon-camera"></i>\
                     <a href="/tail/'+res[i]['id']+'/?val='+val+'" target="_blank">数据快照</a></div></li></ul>';
    $('#loading').hide();	  
	  $('#chart').fadeIn();
	  $('#pagination').fadeIn(); 
	  $('#chart').html(tb);
    }
  }
  
  function handles(dat,num) {
    var dt = dat.toLocaleLowerCase()
        c = {};
        console.log(dt);
    if (dt.indexOf('sitename:')>=0||dt.indexOf('title:')>=0||dt.indexOf('url:')>=0||dt.indexOf('http:')>=0||dt.indexOf('content:')>=0) {
  	  var dt = dt.split(' ');
      for (var i in dt) {
        var s=dt[i].split(':');
        if (s[0]=='sitename'){
          c['sitename']={'$regex':s[1]};
        }else if (s[0]=='url'||s[0]=='http') {
          c['url']={'$regex':s[i]};
          console.log(dt[i]); 
          console.log(c);          
        }else {
          c[s[0]]={'$regex':s[1]}
        }
      }
    }else {
    	c={'content':{'$regex':dt},'title':{'$regex':dt}};
    }
    if (c['siteName']&&c['title']) {
    	con = 'all';
    }else if (c['siteName']) {
    	con = 'siteName';
    }else if (c['title']) {
    	con = 'title';
    }else {
    	con = 0;
    }
    window.values={'val':c,'con':con};
    console.log(values);
    return values;
  }
  
  function handle(dat,num,srh) {
    var sr = {"5":"","6":" sort:ctime=0","7":" sort:ctime=1","8":" sort:gtime=0","9":" sort:gtime=1"};
    if (dat.indexOf('http:')>=0&&dat.indexOf('url:')==-1) {
    	var dat = dat.replace(/http:/,'url:http:').replace(/:/g,'\:');
    }else {
    	var dat = dat.replace(/:/g,'\:');
    } 
  	if (num!=0&&num!=4) {
      	var dat=dat+' AND info_flag:0'+num;
      }else if (num==4) {
      	var dat=dat+' AND info_flag:0401';
      }
      
    dat += sr[srh];
    window.s_d = dat
    console.log(s_d);
    return dat;
  }
  Number.prototype.format = function() {
  return this.toFixed(1).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").replace(/\../,'');
  };
  function getLocalTime(nS) {
        var now = new Date(parseInt(nS))
            get_data = [parseInt(now.getMonth())+1,parseInt(now.getDate()),parseInt(now.getHours()),parseInt(now.getMinutes()),parseInt(now.getSeconds())]
        for (var i=0;i<=4;i++) {
        	if (get_data[i] <10) {
          	get_data[i] = '0' + get_data[i]
          }
        }
        return now.getFullYear()+''+get_data[0]+''+get_data[1]+''+get_data[2]+''+get_data[3]+''+get_data[4];
        }
        
  function datetime_format(num) {
  	var timestamp = Date.parse(new Date());
  	if (num == 1) {
  	  var agotime = timestamp - 3600*1000;
    }else if (num == 24) {
    	var agotime = timestamp - 3600*24*1000;
    }else {
    	var agotime = timestamp - 3600*24*7*1000;
    }
    return 'ctime:['+getLocalTime(agotime)+' TO '+getLocalTime(timestamp)+']';
  }
  
  function binary_segmentation(word) {
//var words = [];
 //   for (var i=word.length;i>=2;i--) {
    //  for (var e=0;e<word.length-i+1;e++) {
       // var wd = word.slice(e,e+i);
        	//  words = words.concat(wd);
     // }	
    //}
       words = word.replace(/'|"|’|“| /g, '').split(/OR|AND|or|and/) 
        return words;
  }
</script>

<script type="text/javascript">
  Number.prototype.format = function() {
  return this.toFixed(1).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").replace(/\../,'');
  };
  function nowscrapy(total) {
    $.getJSON("/total",function (data) {
      console.log(data);
      $('#mongo_sum').text(data.total.format());     
    });
  }
  setInterval("nowscrapy(total)", 2000);
</script>
<script type="text/javascript">
function browser() {
  var isChrome = navigator.userAgent.toLowerCase().match(/chrome/) != null;
  if (isChrome==false) {
    document.getElementById('browser').style.display = "block";
  }
}
</script>
<script>
  $(function() {
    $( "#accordion" ).accordion({
      collapsible: true
    });
    $('.wordtool').click(function () {
    	if (typeof(num)=='undefined') {
      	alert('未发现查询结果，无法筛选数据!!!');
      }else {
      	
      }
    });
    $('.show_hide').click(function () {
    	var sta=$(this).next('.show_ul').css('display');
    	if (sta=='block') {
      	$(this).next('.show_ul').css('display','none');
      }else {
      	$(this).next('.show_ul').css('display','block');
      }
    })
  });
</script>

</head>
<body onload=browser()>
<div class="header">
<h1>  </h1>
</div>
<div class="navigation_tool"><div></div></div>
<div class="search_tool" id="total">
<div id="type">
  <div class="navbar">
    <div class="navbar-inner">
      <ul class="nav">
        <li id="0" class="category active"><a><strong>全部</strong></a></li>
        <li id="1" class="category"><a><strong>新闻</strong></a></li>
        <li id="2" class="category"><a><strong>论坛</strong></a></li>
        <li id="3" class="category"><a><strong>博客</strong></a></li>
        <li id="4" class="category"><a><strong>微博</strong></a></li>
      </ul>
    </div>
  </div>
</div>
<!-- <a href="/" title="返回首页"  target="_blank">
<img src="" style="height:40px;float:left;margin:0px 10px 10px 20px;border:0px;"/>
</a> -->
<div class="search" id="search">
<input type="text" id="kw" class="input_tag" value="" placeholder="待输入..." name='urlq' onkeydown="if(event.keyCode==13){btn.click()}"/>
<input type="button" class="search_btn category" value="再次搜索" id="two_btn" title="开发中，仅支持普通搜索"/>
<input type="button" class="search_btn category"  value="数据搜索" id="btn" />
</div>
<div class="search_message" id="browser">
<p id="mongo">检测到您的浏览器不完全兼容本搜索，可能会给您的使用带来不便，推荐您<a target="_blank" href="http://www.google.cn/intl/zh-CN/chrome/">下载谷歌浏览器</a><p>
</div>
<div class="search_message" id="s_sum"><p id="mongo"><!-- 持久库总数：<b id="mongo_sum">{{total}}</b> 条， --> 提示：使用前请阅读左下方的说明书。</p></div>
<!-- tool start -->
<div style="float: left;width:150px;" id="lc">
<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;" id="gation">
<div class="tabs_title show_hide">数据导出</div><!-- type -->
<ul class="tabs_tool show_ul">
<li> 
  <a class="badges badges-success export" id="txt">txt格式</a> 
</li> 
<li >
  <a class="badges badges-success export" id="excel">excel格式</a>
</li> 
<li> 
  <a class="badges badges-success export" id="sql">sql格式</a> 
</li> 
</ul>
</div>

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;">
<div class="tabs_title show_hide">搜索排序</div><!-- type -->
<ul class="tabs_tool show_ul">
<li><a><span id="5" class="type badges badges-important">默认优先级</span></a></li>
<li><a><span id="6" class="type badges badges-success">发布时间正序</span></a></li>
<li><a><span id="7" class="type badges badges-success">发布时间倒序</span></a></li>
<li><a><span id="8" class="type badges badges-success">采集时间正序</span></a></li>
<li><a><span id="9" class="type badges badges-success">采集时间倒序</span></a></li>
</ul>
</div>

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;">
<div class="tabs_title show_hide">只查选项</div><!-- type -->
<ul class="tabs_tool show_ul">
<li><a><span id="20" class="only badges badges-important">默认</span></a></li>
<li><a><span id="21" class="only badges badges-success">标题</span></a></li>
<li><a><span id="22" class="only badges badges-success">内容</span></a></li>
<li><a><span id="23" class="only badges badges-success">网站名称</span></a></li>
</ul>
</div>

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;">
<div class="tabs_title show_hide">时间范围</div><!-- type -->
<ul class="tabs_tool show_ul" id="option_datetime">
<li><a><span id="24" class="time badges badges-important">系统默认</span></a></li>
<li><a><span id="25" class="time badges badges-success">最近一小时</span></a></li>
<li><a><span id="26" class="time badges badges-success">24小时内</span></a></li>
<li><a><span id="27" class="time badges badges-success">一周内</span></a></li><br />
<li><span class="badges badges-success ">指定范围</span></li>
<li><input readonly class="span1 form_datetime" id="time1" type="text"  placeholder="开始日期..." /></li>
<li><input readonly class="span1 form_datetime" id="time2" type="text"  placeholder="结束日期..." /></li>
<button class="time btn" id="times"><i class="icon-search"></i></button>
</ul>
</div>

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;">
<div class="tabs_title show_hide">词性查询</div><!-- type -->
<ul class="tabs_tool show_ul">
<li><a><span id="28" class="word badges badges-important">默认所有</span></a></li>
<li><a><span id="29" class="word badges badges-success">确定正面</span></a></li>
<li><a><span id="30" class="word badges badges-success">确定负面</span></a></li>
<li><a><span id="31" class="word badges badges-success">确定中性</span></a></li>
<li><a><span id="32" class="word badges badges-success">疑是正面</span></a></li>
<li><a><span id="33" class="word badges badges-success">疑是负面</span></a></li>
<li><a><span id="34" class="word badges badges-success">存在争议</span></a></li><br />
</ul>
</div>

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;margin-top:10px;">

<div style="background-color:#fff;border: 1px solid #d5d5d5;padding:0px;margin-top:10px; ">
<div class="tabs_title show_hide">使用说明</div>
<div class="show_ul" style="text-indent: 0px;font-size: 12px;line-height: 150%;padding: 10px;">
<font style="color: #065;">【快捷键】：</font>输入关键词后,点击回车自动搜素<br/>
<font style="color: #065;">【默认】：</font>输入字符、汉字默认搜索标题内容<br/>
<font style="color: #065;">【网址】：</font>以http:开头默认搜索url选项<br/>
<font style="color: #065;">【引号】：</font>加双引号默认搜索绝对匹配的值，如：输入"舆情早报网",只有标题或内容含有连续的这几个字才会返回<br/>
<font style="color: #065;">【快速搜索】：</font>标题：“title：XXX”，内容：“content:XXX”，站点：“sitename:XXX”，网址：“url:XXX”<br/>
<font style="color: #065;">【时间搜索】：</font>时间范围：“ctime:[20140101120000 TO 20140102120000]”<br/>
<font style="color: #065;">【高级】：</font>组合支持“且(AND)”与“或(OR)”的关系（暂不支持站点与网址的组合查找）<br/>
<font style="color: #065;">【数据导出】：</font>后台暂时默认导出5000条数据，如有疑问咨询技术部：王威威<br/>
<font style="color: #065;">【再搜索】：</font>在当前搜索到的结果集里面进行二次搜索，暂时仅支持默认搜索进行二次搜索<br/>
<font style="color: #065;">【词性查询】：</font>尚未开放使用<br/>
<font style="color: #065;">【组合举例】：</font>标题和内容：“title:XXX AND content:XXX”<br/>
<font style="color: #065;">【组合举例】：</font>标题或时间：“title:XXX OR ctime:[2014010112000 TO 20140102120000]”<br/>
</div>
</div>

</div>
<!-- tool end -->
</div>
<div style="width:740px;float:right;padding:0px;">
<div id="content">
    <div id="chart" class="row-fluid thumbnails">
      {% if tail %}
        <br />
        <ul style="list-style-type:none;">
          <li style="font-size:1.2em;"><a style="color:#1E0FBE; text-decoration:none;" title="{{tail.url}}" href="{{tail.url}}" target="_blank">{{tail.title|safe}}</a></li><br />
          <li><span class="label label-success">来自:&nbsp;</span>{{tail.source}}--{{tail.siteName|safe}}</li><br />
          <li><span class="label label-success">发表时间:&nbsp;</span>{{tail.ctime|date:"Y-m-d H:i:s"}}</li><br />
          <li><span class="label label-success">主要内容:&nbsp;</span>{{tail.content|safe}}</li><br />
          <li>查看数:&nbsp;<span class="badges">{{tail.visitCount}}</span>&nbsp;&nbsp; 回复数:&nbsp;<span class="badges badges-warning">{{tail.replyCount}}</span></li>
          <li><span class="label label-success">入库时间:</span>{{tail.gtime|date:"Y-m-d H:i:s"}}</li>
        </ul>
      {% endif %}    
    </div>
    <div class="pagination" id="pagination">
      <ul id="page">
      </ul>
    </div>
    <div id="loading">
      <img src="/static/img/loading.gif" alt="加载中..."><br /><p>加载中,请稍等...</p>
    </div>
  </div> 
<div id="dialog-form" title="输入账户信息进行下载...">
<p class="validateTips">以下均为必填项！</p>
<form>
<fieldset>
<label for="name">账户名</label>
<input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all" value="">
<label for="password">密码</label>
<input type="password" name="password" id="password" value="" class="text ui-widget-content ui-corner-all">
</fieldset>
</form>
</div>
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
<h3 id="myModalLabel"></h3>
</div>
<div class="modal-body">
<div id="jindutiao" class="progress progress-striped active">
<div class="bar" style="width: 0%;">0%</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary" id="download">下载数据</button>
<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">取消操作</button>
</div>
</div> 
</div>
<script type="text/javascript">
</script>
</div>

<script src="/static/js/bootstrap.min.js"></script>

<script src="/static/js/bootstrap.js"></script>

<script src="/static/js/holder.js"></script>
<script src="/static/js/prettify.js"></script>

<script src="/static/js/application.js"></script>
<script src="/static/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.js"></script>
<script src="/static/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script> 

<script type="text/javascript">
  $(".form_datetime").datetimepicker({format: 'yyyymmddhhii', forceParse: true}); 
</script>
  <script>
    $(function() {
      $( "#menu" ).menu();
    });
  </script>
  <script type="text/javascript"> 
    function displaySubMenu(li) { 
      var subMenu = li.getElementsByTagName("ul")[0]; 
      subMenu.style.display = "block"; 
    } 
    function hideSubMenu(li) { 
      var subMenu = li.getElementsByTagName("ul")[0]; 
      subMenu.style.display = "none"; 
    } 
  </script>
<script>
  $(function() {
    window.wait=0;  
    var name = $( "#name" );
        password = $( "#password" );
        allFields = $( [] ).add( name ).add( password );
        tips = $( ".validateTips" );
    function updateTips( t ) {
      tips.text( t ).addClass( "ui-state-highlight" );
      setTimeout(function() {
      tips.removeClass( "ui-state-highlight", 1500 );
      }, 500 );
    }
    function checkLength( o, n, min, max ) {
      if ( o.val().length > max || o.val().length < min ) {
        o.addClass( "ui-state-error" );
        updateTips( n+"长度必须在" +
        min + "和" + max + "之间" );
        return false;
      } else {
        return true;
      }
    }
    function checkRegexp( o, regexp, n ) {
      if ( !( regexp.test( o.val() ) ) ) {
        o.addClass( "ui-state-error" );
        updateTips( n );
        return false;
      } else {
        return true;
      }
    }
    $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 300,
      width: 400,
      modal: true,
      buttons: {
        "验证账户": function() {
          var bValid = true;
              allFields.removeClass( "ui-state-error" );
              bValid = bValid && checkLength( name, "username", 3, 16 );
              bValid = bValid && checkLength( password, "password", 5, 16 );
              bValid = bValid && checkRegexp( name, /^[a-z]([0-9a-z_])+$/i, "账户名由字母，数字组成，但要以字母开头." );
              bValid = bValid && checkRegexp( password, /^([0-9a-zA-Z])+$/, "密码只能是数字和字母" );
          if ( bValid ) {
            window.username = name.val();
            var passwd = password.val();
            var s_dt0 = s_d;
            $( "#users tbody" ).append( "<tr>" +
              "<td>" + name.val() + "</td>" +
              "<td>" + password.val() + "</td>" +
              "</tr>" ); 
            $.getJSON('/check?username='+username+'&password='+passwd+'&user_md5='+s_dt0,function (data) {
            	if (data['username']==username) {
                $('#download').hide();
                $('#dialog-form')
                .dialog()
                .dialog( "close" );
                $('#myModalLabel').text('正在搜集数据,请稍等...');
                $('#myModal').modal({
                  keyboard: false
                });
                window.usercode = data['usercode'];
                var s_dt = s_d+' export['+usercode+' '+ex_geshi+'='+num+']';
                $.get('http://:192.168.85.18:8080/IndexSearch/search?keyword='+s_dt,function (data) {
                  window.file_zip=data;
                  console.log(file_zip);
                })
                window.interval = setInterval('jindu(usercode)', 1000);
                console.log(s_dt);
              }else {
              	$('.validateTips').text('帐号或密码错误，请重新输入...')
              }
            })
            
          }
        },
        取消验证: function() {
          $( this ).dialog( "close" );
        }
      },
      close: function() {
        allFields.val( "" ).removeClass( "ui-state-error" );
      }
    });
  });
  $( ".export" ).click(function() {      
        if (typeof(num)=='undefined') {
        	alert('未发现查询结果，无法导出数据!!!');        
        }else {
        	$( "#dialog-form" ).dialog( "open" );
        	window.ex_geshi = $(this).attr('id');
        	
        }  
      });
  $('#download').click(function () {
    $('#myModal').modal('hide');
    window.open('http://192.168.85.18:8080/IndexSearch/datazip/'+usercode+'.zip','_blank');
    $('.bar').css({width: '0%'});
    $('.bar').text('0%');
  })
  function save_record(username,option,geshi,sum) {
  	$.post('/save_record/',{'username':username,'option':option,'geshi':geshi,'sum':sum},function (data) {
    })
  }
  function dabao(usercode) {
  	$.get('/jindu?file_name='+usercode,function (data) {
  	  console.log(data);
      if (data=='Success') {
      	clearInterval(inter);
      	$('#myModalLabel').text('打包完成，请点击“下载数据”进行下载！');
    	  $('#download').fadeIn();
    	  save_record(username,s_d,ex_geshi,num);
      }  	
  	})
  }
  
  function jindu(usercode) {
    $.get('/jindu?file_name='+usercode,function (data) {
      console.log(data);
    	if (isNaN(data)==false) {
    	  if (data=='') {
        	var divcss={width: '0%'};
      	  $('.bar').css(divcss);
      	  $('.bar').text('0%');
      	  $('#myModalLabel').text('正在生成文件,请稍等...');
        }else {
        	var divcss={width: data+'%'};
          $('.bar').css(divcss);
          $('.bar').text(data+'%');
          $('#myModalLabel').text('正在生成文件,请稍等...');
      	  if (data=='100') {
      	    clearInterval(interval);
      	    $('#myModalLabel').text('正在打包数据中,请稍等...');
      	    window.inter = setInterval('dabao(usercode)', 1000);       	
          }	        
        }      	
      }else if (data=='Success') {
        window.wait += 1;
        console.log(wait);
        if (wait==20) {
          clearInterval(interval);
          var divcss={width: '100%'};
        	$('.bar').css(divcss);
        	$('.bar').text('100%')
        	$('#myModalLabel').text('打包完成，请点击“下载数据”进行下载！');
      	  $('#download').fadeIn();
      	  save_record(username,s_d,ex_geshi,num);
      	  window.wait=0;
        }
      }else {
      	var divcss={width: '0%'};
      	$('.bar').css(divcss);
      	$('.bar').text('0%');
      }
    })    
  }
</script>
  
</body>
</html>
